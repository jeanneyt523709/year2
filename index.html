<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <!-- ç¢ºä¿è¦–å£è¨­ç½®æ­£ç¢ºï¼Œä»¥å¯¦ç¾éŸ¿æ‡‰å¼è¨­è¨ˆ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Year 2 ä¸­è‹±æ–‡æº«æ›¸å°å¹«æ‰‹</title>
    <style>
        :root {
            /* èª¿æ•´é¡è‰²ä»¥ç¬¦åˆæ´»æ½‘é¢¨æ ¼ */
            --primary-yellow: #FFEB3B; /* äº®é»ƒ */
            --primary-orange: #FF9800; /* æ´»åŠ›æ©™ */
            --sky-blue: #03A9F4; /* å¤©ç©ºè— */
            --ocean-blue: #01579B; /* æ·±è— */
            --english-red: #D32F2F; /* é†’ç›®ç´… */
            --chinese-blue: #00BCD4; /* æ°´è— */
            --success-green: #8BC34A; /* é’è‰ç¶  */
            --bg-color: #E0F7FA; /* æ·ºè—èƒŒæ™¯ */
            --card-bg: #FFFFFF;
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤é»æ“Šæ™‚çš„è—è‰²é«˜äº® */
        }

        body {
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        /* --- Header & Controls --- */
        header {
            background-color: var(--sky-blue);
            width: 100%;
            padding: 15px 10px; /* èª¿æ•´å…§é‚Šè· */
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            margin: 0 0 10px 0;
            color: white;
            font-size: 1.6rem;
            text-shadow: 2px 2px 3px rgba(0,0,0,0.3);
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            max-width: 700px; /* é™åˆ¶å¯¬åº¦ */
            margin: 0 auto;
        }

        select {
            padding: 10px 15px;
            border-radius: 25px;
            border: 3px solid white;
            background: var(--primary-yellow);
            font-size: 0.9rem; /* èª¿æ•´å­—é«”å¤§å°ä»¥é©æ‡‰æ‰‹æ©Ÿ */
            color: #5D4037;
            font-weight: bold;
            outline: none;
            max-width: 100%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        /* æ¡Œé¢ç«¯å„ªåŒ– */
        @media (min-width: 600px) {
             select {
                font-size: 1rem;
             }
        }

        /* --- Navigation Tabs --- */
        .tabs {
            display: flex;
            width: 95%; /* å¢åŠ å¯¬åº¦ä½”æ¯” */
            max-width: 700px;
            margin: 20px auto;
            background: white;
            border-radius: 30px;
            padding: 5px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            justify-content: space-around; /* å‡å‹»åˆ†ä½ˆ */
        }

        .tab-btn {
            flex: 1;
            padding: 10px 5px; 
            border: none;
            background: transparent;
            border-radius: 25px;
            font-size: 0.8rem; /* é‡å°å°å±å¹•å„ªåŒ– */
            font-weight: bold;
            color: #777;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap; /* é˜²æ­¢æ›è¡Œ */
            min-width: 0; /* å…è¨±ç¸®å° */
        }

        /* æ¡Œé¢ç«¯å„ªåŒ– */
        @media (min-width: 600px) {
            .tab-btn {
                 font-size: 1rem;
                 padding: 15px 10px;
            }
        }

        .tab-btn.active {
            background-color: var(--primary-orange);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- Main Content Area --- */
        main {
            width: 95%; /* å¢åŠ å¯¬åº¦ä½”æ¯” */
            max-width: 700px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 40px;
        }

        .mode-container {
            display: none;
            width: 100%;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 0.5s;
        }

        .mode-container.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* --- Flashcard Styles (Mode A) --- */
        .card {
            background: var(--card-bg);
            width: 100%;
            min-height: 300px; /* èª¿æ•´æœ€å°é«˜åº¦ */
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px; /* èª¿æ•´å…§é‚Šè· */
            margin-bottom: 20px;
            text-align: center;
            border: 5px solid var(--primary-yellow);
        }

        .card-english {
            font-size: 2rem; /* æ‰‹æ©Ÿç«¯å­—é«”ç•¥å° */
            color: var(--english-red);
            font-weight: bold;
            margin-bottom: 15px;
            line-height: 1.3;
            word-break: break-word;
        }

        .card-chinese {
            font-size: 1.6rem; /* æ‰‹æ©Ÿç«¯å­—é«”ç•¥å° */
            color: var(--chinese-blue);
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        @media (min-width: 600px) {
             .card-english { font-size: 2.5rem; }
             .card-chinese { font-size: 2rem; }
             .card { min-height: 350px; }
        }

        .breakdown-area {
            margin-top: 15px;
            padding: 10px;
            background: #F4F8FF;
            border-radius: 10px;
            font-size: 1rem; /* èª¿æ•´å­—é«”å¤§å° */
            color: #555;
            display: none;
            width: 100%;
        }

        .breakdown-area.show {
            display: block;
        }

        /* --- Quiz Styles (Mode B & C) --- */
        .quiz-header {
            font-size: 1.4rem; /* æ‰‹æ©Ÿç«¯å­—é«”ç•¥å° */
            color: var(--chinese-blue);
            margin-bottom: 20px;
            font-weight: bold;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            justify-content: center;
            padding: 10px;
            text-align: center;
        }
        
        @media (min-width: 600px) {
            .quiz-header { font-size: 1.8rem; }
        }

        .sound-btn {
            background: var(--primary-orange);
            border: none;
            min-width: 45px; /* æœ€å°è§¸æ§ç›®æ¨™ */
            height: 45px;
            padding: 0 10px;
            border-radius: 25px;
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        /* Specific button style for quiz headers where space is tighter */
        .quiz-header .sound-btn {
            min-width: 35px;
            width: 40px; /* ç•¥å¾®ç¸®å° */
            height: 40px;
            font-size: 0.8rem;
            padding: 0;
        }

        .sound-btn:active {
            transform: scale(0.9);
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* Mode B: Blocks */
        .answer-zone {
            min-height: 70px; /* èª¿æ•´æœ€å°é«˜åº¦ */
            width: 100%;
            border: 2px dashed #ccc;
            border-radius: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* èª¿æ•´é–“è· */
            justify-content: center;
            align-items: center;
            padding: 10px;
            margin-bottom: 15px;
            background: #FFFCF3;
        }

        .word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 10px; /* èª¿æ•´é–“è· */
            justify-content: center;
            padding: 10px;
            margin-bottom: 15px;
            border-top: 2px solid #EEE;
            padding-top: 20px;
        }

        .word-block {
            background: white;
            border: 3px solid var(--sky-blue);
            color: var(--ocean-blue);
            padding: 8px 15px; /* èª¿æ•´å…§é‚Šè· */
            border-radius: 20px;
            font-size: 1.1rem; /* èª¿æ•´å­—é«”å¤§å° */
            cursor: pointer;
            user-select: none;
            font-weight: bold;
            box-shadow: 0 4px 0 var(--sky-blue);
            transition: transform 0.1s;
        }
        
        @media (min-width: 600px) {
             .word-block { font-size: 1.2rem; padding: 10px 18px; }
        }

        .word-block:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        .word-block.used {
            opacity: 0.4;
            pointer-events: none;
            background: #E0E0E0;
            border-color: #BDBDBD;
            box-shadow: none;
        }

        /* Mode C: Input */
        .input-box {
            width: 100%;
            padding: 15px; /* èª¿æ•´å…§é‚Šè· */
            font-size: 1.3rem; /* èª¿æ•´å­—é«”å¤§å° */
            border: 4px solid var(--sky-blue);
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
            outline: none;
            color: var(--english-red);
            font-weight: bold;
        }
        
        @media (min-width: 600px) {
             .input-box { font-size: 1.5rem; padding: 18px; }
        }

        /* --- Common Buttons --- */
        .action-btn {
            background-color: var(--success-green);
            color: white;
            border: none;
            padding: 12px 30px; /* èª¿æ•´å…§é‚Šè· */
            font-size: 1.1rem; /* èª¿æ•´å­—é«”å¤§å° */
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 0 #558B2F;
            margin-top: 10px;
            transition: all 0.1s;
        }
        
        @media (min-width: 600px) {
             .action-btn { font-size: 1.2rem; padding: 14px 40px; }
        }

        .action-btn:active {
            transform: translateY(5px);
            box-shadow: none;
        }

        .nav-buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 25px;
            align-items: center;
        }

        .nav-btn {
            background: #E0E0E0;
            border: none;
            padding: 10px 20px; /* èª¿æ•´å…§é‚Šè· */
            border-radius: 25px;
            font-size: 0.9rem; /* èª¿æ•´å­—é«”å¤§å° */
            cursor: pointer;
            color: #555;
            font-weight: bold;
            box-shadow: 0 3px 0 #BDBDBD;
        }
        
        @media (min-width: 600px) {
             .nav-btn { font-size: 1rem; padding: 12px 24px; }
        }
        
        .nav-btn:active {
            transform: translateY(3px);
            box-shadow: none;
        }
        
        .next-btn-highlight {
            background: var(--primary-orange) !important;
            color: white !important;
            box-shadow: 0 3px 0 #E65100 !important;
        }

        .toggle-btn {
            background: #FFFDE7;
            border: 2px solid var(--primary-yellow);
            padding: 8px 16px;
            border-radius: 20px;
            color: #666;
            font-size: 0.9rem;
            cursor: pointer;
            margin-top: 15px;
            font-weight: bold;
        }

        /* --- Feedback & Progress --- */
        .feedback-msg {
            height: 35px;
            margin-top: 10px;
            font-weight: 800;
            font-size: 1.2rem; /* èª¿æ•´å­—é«”å¤§å° */
            text-align: center;
            line-height: 1.2;
        }
        .correct { color: var(--success-green); }
        .wrong { color: var(--english-red); }

        .progress-indicator {
            font-size: 0.9rem; /* èª¿æ•´å­—é«”å¤§å° */
            color: #555;
            font-weight: bold;
            background: white;
            padding: 8px 18px;
            border-radius: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* --- MODE D: GAME STYLES --- */
        .game-grid {
            /* é è¨­æ‰‹æ©Ÿä½ˆå±€: 3x4 (12 å¼µå¡ç‰‡) */
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            width: 100%;
            margin: 20px 0;
        }
        
        /* åœ¨ç¨å¯¬çš„è¨­å‚™ä¸Šä½¿ç”¨ 4x3 ä½ˆå±€ */
        @media (min-width: 400px) {
            .game-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 12px;
            }
        }
        
        /* æ¡Œé¢/å¹³æ¿ä½ˆå±€ */
        @media (min-width: 600px) {
            .game-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }
        }

        .game-card-container {
            perspective: 1000px;
            /* ä¿æŒç¸±æ©«æ¯”ä¸€è‡´ï¼Œä½¿å¡ç‰‡é«˜åº¦è‡ªé©æ‡‰å¯¬åº¦ */
            padding-top: 100%; /* 1:1 æ¯”ä¾‹ */
            position: relative;
            cursor: pointer;
            pointer-events: auto;
        }
        
        /* ç¢ºä¿å¡ç‰‡å…§å®¹å¡«æ»¿å®¹å™¨ */
        .game-card, .card-face {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }


        .game-card-container.matched {
            pointer-events: none;
            opacity: 0.5;
            transition: opacity 0.5s;
        }

        .game-card {
            transition: transform 0.6s;
            transform-style: preserve-3d;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .game-card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            backface-visibility: hidden;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            padding: 5px;
            text-align: center;
            overflow: hidden;
            font-size: 0.9rem; /* é è¨­å­—é«”å¤§å° */
        }
        
        /* æ¡Œé¢ç«¯å­—é«”ç•¥å¤§ */
        @media (min-width: 600px) {
             .card-face { font-size: 1.1rem; }
        }

        .card-front {
            background-color: var(--primary-yellow);
            color: var(--ocean-blue);
            border: 3px solid var(--primary-orange);
            font-size: 2rem; /* æ­£é¢åœ–æ¨™æˆ–ä¸­/è‹±å­—æ¨£æ›´å¤§ */
        }
        
        .card-back {
            background-color: var(--card-bg);
            transform: rotateY(180deg);
            border: 3px solid var(--english-red);
            font-size: 0.9rem; /* å¯¦éš›å…§å®¹å­—é«” */
        }
        
        .game-status {
            width: 100%;
            text-align: center;
            font-size: 1.1rem; /* èª¿æ•´å­—é«”å¤§å° */
            font-weight: bold;
            color: #555;
            margin-bottom: 10px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .game-status span {
            color: var(--primary-orange);
        }
    </style>
</head>
<body>

<header>
    <h1>Year 2 ä¸­è‹±æ–‡æº«æ›¸ App</h1>
    <div class="controls">
        <!-- Level Selector -->
        <select id="levelSelect" onchange="changeLevel()">
            <!-- Populated by JS -->
        </select>
        
        <!-- è‹±æ–‡èªéŸ³é¸æ“‡å™¨å·²ç§»é™¤ï¼Œç¾ç”± JS è‡ªå‹•é¸æ“‡ UK English -->
    </div>
</header>

<nav class="tabs">
    <button class="tab-btn active" onclick="switchMode('learn')">A. å­¸ç¿’ (Learn)</button>
    <button class="tab-btn" onclick="switchMode('blocks')">B. ç©æœ¨ (Build)</button>
    <button class="tab-btn" onclick="switchMode('dictation')">C. è½å¯« (Spell)</button>
    <button class="tab-btn" onclick="switchMode('game')">D. é…å°éŠæˆ² (Match)</button>
</nav>

<main>
    <!-- MODE A: LEARN -->
    <div id="mode-learn" class="mode-container active">
        <div class="card">
            <div id="learn-en" class="card-english">è¼‰å…¥ä¸­...</div>
            <div id="learn-ch" class="card-chinese">è¼‰å…¥ä¸­...</div>
            
            <button class="toggle-btn" onclick="toggleBreakdown()">é¡¯ç¤º/éš±è—éŸ³ç¯€/æ‹†è§£</button>
            <div id="learn-breakdown" class="breakdown-area">
                <!-- Breakdown inserted here -->
            </div>

            <!-- Dual Sound Buttons for Learn Mode -->
            <div style="display:flex; gap: 20px; margin-top:20px;">
                <button class="sound-btn" onclick="playCurrentChineseWord()" title="æ’­æ”¾ä¸­æ–‡ (ç²µèª)">ğŸ‡¨ğŸ‡³ ç²µèª</button>
                <button class="sound-btn" onclick="playCurrentEnglishWord()" title="æ’­æ”¾è‹±æ–‡ (UK English)">ğŸ‡¬ğŸ‡§ è‹±æ–‡</button>
            </div>
        </div>
        
        <div class="nav-buttons">
            <button class="nav-btn" onclick="prevCard()">â—€ ä¸Šä¸€å€‹</button>
            <div class="progress-indicator"><span id="learn-index">1</span> / <span id="total-count">?</span></div>
            <button class="nav-btn next-btn-highlight" onclick="nextCard()">ä¸‹ä¸€å€‹ â–¶</button>
        </div>
    </div>

    <!-- MODE B: BLOCKS -->
    <div id="mode-blocks" class="mode-container">
        <div class="quiz-header">
            <!-- Dual Sound Buttons for Quiz Mode -->
            <div style="display:flex; gap: 10px;">
                <button class="sound-btn quiz-header-btn" onclick="playCurrentChineseWord()" title="æ’­æ”¾ä¸­æ–‡ (ç²µèª)">ç²µ</button>
                <button class="sound-btn quiz-header-btn" onclick="playCurrentEnglishWord()" title="æ’­æ”¾è‹±æ–‡ (UK English)">è‹±</button>
            </div>
            <span id="block-ch">ä¸­æ–‡é¡Œç›®</span>
        </div>

        <div class="answer-zone" id="block-answer-zone">
            <!-- Selected blocks appear here -->
        </div>

        <div class="word-bank" id="block-bank">
            <!-- Random blocks appear here -->
        </div>

        <div id="block-feedback" class="feedback-msg"></div>

        <button class="action-btn" onclick="checkBlockAnswer()">æª¢æŸ¥ç­”æ¡ˆ (Check)</button>

        <div class="nav-buttons">
            <button class="nav-btn" onclick="prevCard()">â—€ ä¸Šä¸€é¡Œ</button>
            <div class="progress-indicator"><span id="block-index">1</span> / <span id="block-total">?</span></div>
            <button class="nav-btn next-btn-highlight" onclick="nextCard()">ä¸‹ä¸€é¡Œ â–¶</button>
        </div>
    </div>

    <!-- MODE C: DICTATION -->
    <div id="mode-dictation" class="mode-container">
        <div class="quiz-header">
            <!-- Dual Sound Buttons for Quiz Mode -->
            <div style="display:flex; gap: 10px;">
                <button class="sound-btn quiz-header-btn" onclick="playCurrentChineseWord()" title="æ’­æ”¾ä¸­æ–‡ (ç²µèª)">ç²µ</button>
                <button class="sound-btn quiz-header-btn" onclick="playCurrentEnglishWord()" title="æ’­æ”¾è‹±æ–‡ (UK English)">è‹±</button>
            </div>
            <span id="dict-ch">ä¸­æ–‡é¡Œç›®</span>
        </div>

        <p style="color:#666; font-size:1rem; margin-bottom:10px;">è«‹è¼¸å…¥è‹±æ–‡è§£é‡‹ (Type English):</p>
        <input type="text" id="dict-input" class="input-box" placeholder="åœ¨æ­¤è¼¸å…¥..." autocomplete="off" onkeypress="handleEnter(event)">

        <div id="dict-feedback" class="feedback-msg"></div>

        <button class="action-btn" onclick="checkDictationAnswer()">æäº¤ (Submit)</button>

        <div class="nav-buttons">
            <button class="nav-btn" onclick="prevCard()">â—€ ä¸Šä¸€é¡Œ</button>
            <div class="progress-indicator"><span id="dict-index">1</span> / <span id="dict-total">?</span></div>
            <button class="nav-btn next-btn-highlight" onclick="nextCard()">ä¸‹ä¸€é¡Œ â–¶</button>
        </div>
    </div>

    <!-- MODE D: GAME (New!) -->
    <div id="mode-game" class="mode-container">
        <h2 style="color:var(--ocean-blue); font-size:1.5rem;">é…å°éŠæˆ² (Match Game)</h2>
        <p style="color:#666; text-align:center; font-size:0.9rem;">ğŸ’¡ é»æ“Šå¡ç‰‡ç¿»é–‹ï¼Œæ‰¾å‡ºä¸­æ–‡å’Œè‹±æ–‡çš„é…å°ï¼</p>
        
        <div id="game-status" class="game-status">å˜—è©¦æ¬¡æ•¸: <span id="game-attempts">0</span> | å·²é…å°: <span id="game-matches">0</span> / 6</div>

        <div id="game-grid" class="game-grid">
            <!-- Game cards will be rendered here -->
            <p style="grid-column: 1 / -1; text-align: center;">é»æ“Šã€Œé‡æ–°é–‹å§‹ã€é–‹å§‹éŠæˆ²</p>
        </div>
        
        <button class="action-btn" onclick="setupGame()">é‡æ–°é–‹å§‹ (Restart Game)</button>
        <div id="game-end-feedback" class="feedback-msg"></div>
    </div>
</main>

<script>
    // --- 1. è³‡æ–™åº« (Year 2 é»˜æ›¸å…§å®¹) ---
    const rawData = [
        // ç¬¬ä¸€æ¬¡é»˜æ›¸
        { ch: "ä»€éº¼", en: "what", parts: ["what"], group: "ç¬¬ä¸€æ¬¡é»˜æ›¸" },
        { ch: "ä½ å«ä»€éº¼?", en: "What are you called?", parts: ["What", "are", "you", "called"], group: "ç¬¬ä¸€æ¬¡é»˜æ›¸" },
        { ch: "æˆ‘å«", en: "I am called", parts: ["I", "am", "called"], group: "ç¬¬ä¸€æ¬¡é»˜æ›¸" },
        { ch: "çˆ¸çˆ¸", en: "Dad", parts: ["Dad"], group: "ç¬¬ä¸€æ¬¡é»˜æ›¸" },
        { ch: "åª½åª½", en: "Mum", parts: ["Mum"], group: "ç¬¬ä¸€æ¬¡é»˜æ›¸" },

        // ç¬¬äºŒæ¬¡é»˜æ›¸
        { ch: "é€™æ˜¯èª°?", en: "Who is this?", parts: ["Who", "is", "this"], group: "ç¬¬äºŒæ¬¡é»˜æ›¸" },
        { ch: "é€™æ˜¯æˆ‘çš„å¼Ÿå¼Ÿ", en: "This is my younger brother", parts: ["This", "is", "my", "younger", "brother"], group: "ç¬¬äºŒæ¬¡é»˜æ›¸" },
        { ch: "æˆ‘å€‘", en: "We", parts: ["We"], group: "ç¬¬äºŒæ¬¡é»˜æ›¸" },
        { ch: "ä½ å€‘", en: "You (more than one)", parts: ["You"], group: "ç¬¬äºŒæ¬¡é»˜æ›¸" },

        // ç¬¬ä¸‰æ¬¡é»˜æ›¸
        { ch: "é»‘è‰²", en: "Black", parts: ["Black"], group: "ç¬¬ä¸‰æ¬¡é»˜æ›¸" },
        { ch: "ç™½è‰²", en: "White", parts: ["White"], group: "ç¬¬ä¸‰æ¬¡é»˜æ›¸" },
        { ch: "æ©™è‰²", en: "Orange", parts: ["Or-ange"], group: "ç¬¬ä¸‰æ¬¡é»˜æ›¸" },
        { ch: "è—è‰²", en: "Blue", parts: ["Blue"], group: "ç¬¬ä¸‰æ¬¡é»˜æ›¸" },
        { ch: "æˆ‘å–œæ­¡", en: "I like", parts: ["I", "like"], group: "ç¬¬ä¸‰æ¬¡é»˜æ›¸" },

        // ç¬¬å››æ¬¡é»˜æ›¸
        { ch: "ä½ å–œæ­¡é»‘è‰²å’Œç™½è‰²", en: "You like black and white", parts: ["You", "like", "black", "and", "white"], group: "ç¬¬å››æ¬¡é»˜æ›¸" },
        { ch: "å“¥å“¥ä¸å–œæ­¡æ©™è‰²å’Œè—è‰²", en: "Elder brother does not like orange and blue", parts: ["Elder", "brother", "does", "not", "like", "orange", "and", "blue"], group: "ç¬¬å››æ¬¡é»˜us" },

        // ç¬¬äº”æ¬¡é»˜æ›¸
        { ch: "æ±—è¡«", en: "T shirt", parts: ["T", "shirt"], group: "ç¬¬äº”æ¬¡é»˜æ›¸" },
        { ch: "æ¯›è¡£", en: "Jumper", parts: ["Jump-er"], group: "ç¬¬äº”æ¬¡é»˜æ›¸" },
        { ch: "è¤²å­", en: "Pants", parts: ["Pants"], group: "ç¬¬äº”æ¬¡é»˜æ›¸" },
        { ch: "é‹å­", en: "shoes", parts: ["shoes"], group: "ç¬¬äº”æ¬¡é»˜æ›¸" },
        { ch: "è£™å­", en: "dress", parts: ["dress"], group: "ç¬¬äº”æ¬¡é»˜æ›¸" },

        // ç¬¬å…­æ¬¡é»˜æ›¸ (å°‡ 'trousers' è¨­ç‚ºä¸»è¦ç­”æ¡ˆï¼Œå› ç‚ºå¥å­æ›´å¸¸ç”¨)
        { ch: "ä¸€ä»¶æ±—è¡«", en: "One T shirt", parts: ["One", "T", "shirt"], group: "ç¬¬å…­æ¬¡é»˜æ›¸" },
        { ch: "å…©ä»¶æ¯›è¡£", en: "Two jumpers", parts: ["Two", "jump-ers"], group: "ç¬¬å…­æ¬¡é»˜æ›¸" },
        { ch: "ä¸‰æ¢è¤²å­", en: "Three trousers", parts: ["Three", "trou-sers"], group: "ç¬¬å…­æ¬¡é»˜æ›¸" },
        { ch: "å››é›™é‹å­", en: "Four pairs of shoes", parts: ["Four", "pairs", "of", "shoes"], group: "ç¬¬å…­æ¬¡é»˜æ›¸" },
        { ch: "å…©æ¢è£™å­", en: "Two dresses", parts: ["Two", "dres-ses"], group: "ç¬¬å…­æ¬¡é»˜æ›¸" },

        // ç¬¬ä¸ƒæ¬¡é»˜æ›¸
        { ch: "æˆ‘æœ‰ä¸€ä»¶æ±—è¡«", en: "I have one T shirt", parts: ["I", "have", "one", "T", "shirt"], group: "ç¬¬ä¸ƒæ¬¡é»˜æ›¸" },
        { ch: "çˆ¸çˆ¸æœ‰å…©é›™é‹å­", en: "Dad has two pairs of shoes", parts: ["Dad", "has", "two", "pairs", "of", "shoes"], group: "ç¬¬ä¸ƒæ¬¡é»˜æ›¸" },
        { ch: "å§å§æœ‰å…©æ¢è£™å­", en: "Elder sister has two dresses", parts: ["Elder", "sister", "has", "two", "dres-ses"], group: "ç¬¬ä¸ƒæ¬¡é»˜æ›¸" }
    ];

    // --- 2. ç‹€æ…‹ç®¡ç† ---
    let currentLevelData = [];
    let currentIndex = 0;
    let currentMode = 'learn';
    let voices = [];
    let cantoneseVoice = null;
    let preferredEnVoice = null; // æ–°å¢ï¼šç”¨æ–¼å„²å­˜é è¨­çš„è‹±æ–‡èªéŸ³
    
    // Game State
    let gameCards = [];
    let cardsFlipped = [];
    let matchesFound = 0;
    let attempts = 0;
    let isProcessing = false;
    
    // --- 3. åˆå§‹åŒ– ---
    window.onload = function() {
        initVoices(); // ä½¿ç”¨æ–°çš„èªéŸ³åˆå§‹åŒ–å‡½æ•¸
        initLevels();
        loadLevel(rawData[0].group); // Default to the first group
    };

    // --- 4. åˆ†çµ„é‚è¼¯ ---
    function initLevels() {
        const select = document.getElementById('levelSelect');
        select.innerHTML = '';
        
        // Use a Set to get unique group names
        const groups = [...new Set(rawData.map(item => item.group))];
        
        groups.forEach(groupName => {
            let option = document.createElement('option');
            option.value = groupName;
            
            // Count items in this group
            const count = rawData.filter(item => item.group === groupName).length;
            
            option.text = `${groupName} (${count} å€‹)`;
            select.appendChild(option);
        });

        // Add "All" option
        let allOption = document.createElement('option');
        allOption.value = 'all';
        allOption.text = `å…¨éƒ¨å–®å­— (${rawData.length} å€‹)`;
        select.appendChild(allOption);
    }

    function loadLevel(groupValue) {
        if (groupValue === 'all') {
            currentLevelData = [...rawData];
        } else {
            // Filter by the group name (which is the value)
            currentLevelData = rawData.filter(item => item.group === groupValue);
        }
        currentIndex = 0;
        updateUI();
    }

    function changeLevel() {
        const select = document.getElementById('levelSelect');
        loadLevel(select.value);
    }

    // --- 5. èªéŸ³ç³»çµ± (å·²ä¿®æ”¹ç‚ºè‡ªå‹•é¸æ“‡ UK English) ---
    function initVoices() {
        
        function findVoices() {
            voices = window.speechSynthesis.getVoices();
            cantoneseVoice = null; 
            preferredEnVoice = null;

            // 1. Find Best Cantonese Voice (Prioritize HK Cantonese)
            cantoneseVoice = voices.find(v => v.lang === 'zh-HK' || v.lang.includes('yue'));
            if (!cantoneseVoice) {
                cantoneseVoice = voices.find(v => v.lang.includes('zh'));
            }

            // 2. Find Best UK English Voice (Default setting)
            // Priority: en-GB -> en-US -> first available en voice
            preferredEnVoice = voices.find(v => v.lang === 'en-GB') || 
                               voices.find(v => v.lang === 'en-US') ||
                               voices.find(v => v.lang.includes('en'));

            if (!preferredEnVoice) {
                console.warn("No English voice found. Speech synthesis may not work.");
            }
        }

        findVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = findVoices;
        }
    }

    function playText(text, isChinese) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.8;

        if (isChinese) {
            // Use Cantonese/Chinese Voice
            if (cantoneseVoice) {
                utterance.voice = cantoneseVoice;
                utterance.lang = cantoneseVoice.lang;
            } else {
                utterance.lang = 'zh-HK'; 
            }
        } else {
            // Use Default English Voice (UK Preferred)
            if (preferredEnVoice) {
                utterance.voice = preferredEnVoice;
                utterance.lang = preferredEnVoice.lang;
            } else {
                utterance.lang = 'en-GB'; // Fallback lang
            }
        }

        window.speechSynthesis.speak(utterance);
    }

    function playCurrentEnglishWord() {
        if(currentLevelData.length === 0) return;
        playText(currentLevelData[currentIndex].en, false);
    }

    function playCurrentChineseWord() {
        if(currentLevelData.length === 0) return;
        playText(currentLevelData[currentIndex].ch, true);
    }

    // --- 6. æ ¸å¿ƒæ¸²æŸ“é‚è¼¯ ---
    function switchMode(mode) {
        // Reset UI states
        document.getElementById('mode-learn').classList.remove('active');
        document.getElementById('mode-blocks').classList.remove('active');
        document.getElementById('mode-dictation').classList.remove('active');
        document.getElementById('mode-game').classList.remove('active');
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        
        currentMode = mode;
        document.getElementById(`mode-${mode}`).classList.add('active');
        
        const tabIndex = mode === 'learn' ? 0 : mode === 'blocks' ? 1 : mode === 'dictation' ? 2 : 3;
        document.querySelectorAll('.tab-btn')[tabIndex].classList.add('active');

        if (mode === 'game') {
            setupGame();
        } else {
            updateUI();
        }
    }

    function updateUI() {
        if (currentLevelData.length === 0) return;
        const word = currentLevelData[currentIndex];

        // Setup Counters
        const currentCount = currentIndex + 1;
        const totalCount = currentLevelData.length;
        document.getElementById('learn-index').innerText = currentCount;
        document.getElementById('total-count').innerText = totalCount;
        document.getElementById('block-index').innerText = currentCount;
        document.getElementById('block-total').innerText = totalCount;
        document.getElementById('dict-index').innerText = currentCount;
        document.getElementById('dict-total').innerText = totalCount;


        // Reset Feedbacks and Inputs
        document.getElementById('block-feedback').innerText = '';
        document.getElementById('block-feedback').className = 'feedback-msg';
        document.getElementById('dict-feedback').innerText = '';
        document.getElementById('dict-feedback').className = 'feedback-msg';
        document.getElementById('dict-input').value = '';
        document.getElementById('block-answer-zone').innerHTML = '';


        // Mode A: Learn
        document.getElementById('learn-en').innerText = word.en;
        document.getElementById('learn-ch').innerText = word.ch;
        const breakdownHtml = word.parts && word.parts.length > 0 ? word.parts.join(' - ') : "ç„¡æ‹†è§£è³‡æ–™";
        document.getElementById('learn-breakdown').innerHTML = `éŸ³ç¯€/å­—è©æ‹†è§£: ${breakdownHtml}`;
        document.getElementById('learn-breakdown').classList.remove('show');

        // Mode B: Blocks
        document.getElementById('block-ch').innerText = word.ch;
        setupBlocks(word.en);

        // Mode C: Dictation
        document.getElementById('dict-ch').innerText = word.ch;
    }

    function nextCard() {
        if (currentIndex < currentLevelData.length - 1) {
            currentIndex++;
            updateUI();
        } else {
            const msg = "æ­å–œï¼ä½ å·²ç¶“å®Œæˆé€™çµ„å–®å­—äº†ï¼(Level Completed!)";
            // Use custom modal or console log instead of alert
            console.log(msg);
            alert(msg); // Keeping alert for simplicity here, but in a real app, use a custom modal
        }
    }

    function prevCard() {
        if (currentIndex > 0) {
            currentIndex--;
            updateUI();
        }
    }

    // --- Mode A Logic ---
    function toggleBreakdown() {
        const el = document.getElementById('learn-breakdown');
        el.classList.toggle('show');
    }

    // --- Mode B Logic (Blocks) ---
    function setupBlocks(englishText) {
        const container = document.getElementById('block-bank');
        container.innerHTML = '';
        
        let parts = englishText.split(' ').filter(p => p.trim() !== ''); // Split by space and clean
        
        // Shuffle
        let shuffled = [...parts].sort(() => Math.random() - 0.5);

        shuffled.forEach((part) => {
            let btn = document.createElement('div');
            btn.className = 'word-block';
            btn.innerText = part;
            btn.onclick = function() {
                moveBlockToAnswer(btn, part);
            };
            container.appendChild(btn);
        });
    }

    function moveBlockToAnswer(btnElement, text) {
        if (btnElement.classList.contains('used')) return;

        const zone = document.getElementById('block-answer-zone');
        
        let answerBlock = document.createElement('div');
        answerBlock.className = 'word-block';
        answerBlock.innerText = text;
        answerBlock.style.background = '#FFF9C4';
        
        answerBlock.onclick = function() {
            zone.removeChild(answerBlock);
            btnElement.classList.remove('used');
        };

        zone.appendChild(answerBlock);
        btnElement.classList.add('used');
    }

    function checkBlockAnswer() {
        const word = currentLevelData[currentIndex];
        const zone = document.getElementById('block-answer-zone');
        const userAns = Array.from(zone.children).map(c => c.innerText).join(' ');
        const feedback = document.getElementById('block-feedback');
        
        // Use a stricter comparison by normalizing spaces and case
        const target = word.en.replace(/\s+/g, ' ').trim().toLowerCase();
        const user = userAns.replace(/\s+/g, ' ').trim().toLowerCase();


        if (user === target) {
            feedback.innerText = "â˜… ç­”å°äº†ï¼ Correct! â˜…";
            feedback.className = "feedback-msg correct";
            playCurrentEnglishWord(); // Play English sound on success
        } else {
            feedback.innerText = "å†è©¦ä¸€æ¬¡ï¼ Try again.";
            feedback.className = "feedback-msg wrong";
        }
    }

    // --- Mode C Logic (Dictation) ---
    function handleEnter(e) {
        if (e.key === 'Enter') checkDictationAnswer();
    }

    function checkDictationAnswer() {
        const word = currentLevelData[currentIndex];
        const input = document.getElementById('dict-input');
        const feedback = document.getElementById('dict-feedback');
        
        // Stricter comparison is usually better for dictation
        const target = word.en.trim().toLowerCase();
        const user = input.value.trim().toLowerCase();
        
        if (user === target) {
            feedback.innerText = "â˜… å¤ªæ£’äº†ï¼ Excellent! â˜…";
            feedback.className = "feedback-msg correct";
            playCurrentEnglishWord(); // Play English sound on success
        } else {
            feedback.innerText = `æ­£ç¢ºç­”æ¡ˆæ˜¯: ${word.en}`;
            feedback.className = "feedback-msg wrong";
        }
    }

    // --- Mode D Logic (Game) ---

    // Utility function to get N random items from an array
    function getRandomSubset(arr, size) {
        if (arr.length < size) return arr;
        let shuffled = [...arr].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, size);
    }

    function setupGame() {
        if (currentLevelData.length < 6) {
             const msg = "é€™çµ„å–®å­—ä¸è¶³ 6 å€‹ï¼Œè«‹é¸æ“‡ä¸€çµ„æ›´å¤§çš„ç¯„åœï¼ˆä¾‹å¦‚ã€Œå…¨éƒ¨å–®å­—ã€ï¼‰æ‰èƒ½ç©éŠæˆ²ï¼";
             document.getElementById('game-grid').innerHTML = `<p style="grid-column: 1 / -1; color: ${getComputedStyle(document.body).getPropertyValue('--english-red').trim()};">${msg}</p>`;
             document.getElementById('game-end-feedback').innerText = "";
             document.getElementById('game-attempts').innerText = 0;
             document.getElementById('game-matches').innerText = 0;
             return;
        }

        // 1. Get 6 random words from the current data set
        const selectedWords = getRandomSubset(currentLevelData, 6);
        
        // 2. Create the cards (Chinese and English pairs)
        gameCards = [];
        selectedWords.forEach((word, index) => {
            // Chinese card (Front)
            gameCards.push({
                id: index, // Unique ID for matching
                content: word.ch,
                type: 'ch',
                isFlipped: false,
                isMatched: false
            });
            // English card (Back)
            gameCards.push({
                id: index, // Same ID for matching
                content: word.en,
                type: 'en',
                isFlipped: false,
                isMatched: false
            });
        });

        // 3. Shuffle the entire deck
        gameCards.sort(() => Math.random() - 0.5);

        // 4. Reset game state
        cardsFlipped = [];
        matchesFound = 0;
        attempts = 0;
        isProcessing = false;
        document.getElementById('game-end-feedback').innerText = "";

        // 5. Render the grid
        renderGameGrid();
    }

    function renderGameGrid() {
        const grid = document.getElementById('game-grid');
        grid.innerHTML = '';
        document.getElementById('game-attempts').innerText = attempts;
        document.getElementById('game-matches').innerText = matchesFound;

        gameCards.forEach((cardData, index) => {
            const container = document.createElement('div');
            container.className = `game-card-container ${cardData.isMatched ? 'matched' : ''}`;
            container.setAttribute('data-index', index);
            container.onclick = () => flipCard(container, index);

            const card = document.createElement('div');
            card.className = `game-card ${cardData.isFlipped || cardData.isMatched ? 'flipped' : ''}`;

            const front = document.createElement('div');
            front.className = 'card-face card-front';
            
            const back = document.createElement('div');
            back.className = 'card-face card-back';
             
            // The default front (unflipped) should just be the type indicator
            front.innerText = cardData.type === 'ch' ? 'ä¸­' : 'è‹±';
            front.style.fontSize = '2rem';
            front.style.color = cardData.type === 'ch' ? 'var(--chinese-blue)' : 'var(--english-red)';
            
            // The back (flipped) displays the actual content
            back.innerText = cardData.content;
            back.style.color = cardData.type === 'ch' ? 'var(--chinese-blue)' : 'var(--english-red)';
            back.style.border = `3px solid ${cardData.type === 'ch' ? 'var(--chinese-blue)' : 'var(--english-red)'}`;


            card.appendChild(front);
            card.appendChild(back);
            container.appendChild(card);
            grid.appendChild(container);
        });
    }

    function flipCard(cardContainer, index) {
        const cardData = gameCards[index];
        
        if (isProcessing || cardData.isFlipped || cardData.isMatched) return;

        // 1. Flip the card (visually and in data)
        const cardEl = cardContainer.querySelector('.game-card');
        cardEl.classList.add('flipped');
        cardData.isFlipped = true;
        cardsFlipped.push(cardData);
        
        // Get content based on type for the back face (what the user sees)
        const content = cardData.content;
        
        // Optional: Play sound of the flipped word
        playText(content, cardData.type === 'ch');


        // 2. Check for second card
        if (cardsFlipped.length === 2) {
            isProcessing = true; // Prevent further flips
            attempts++;
            document.getElementById('game-attempts').innerText = attempts;

            const card1 = cardsFlipped[0];
            const card2 = cardsFlipped[1];

            // Match condition: Different types (ch/en) but same ID
            if (card1.id === card2.id && card1.type !== card2.type) {
                // IT'S A MATCH!
                matchesFound++;
                card1.isMatched = true;
                card2.isMatched = true;

                // Mark visually as matched (dimmed and non-clickable)
                document.querySelector(`[data-index="${gameCards.indexOf(card1)}"]`).classList.add('matched');
                document.querySelector(`[data-index="${gameCards.indexOf(card2)}"]`).classList.add('matched');

                document.getElementById('game-end-feedback').innerText = "âœ“ é…å°æˆåŠŸï¼Good Match!";
                document.getElementById('game-end-feedback').className = 'feedback-msg correct';
                
                cardsFlipped = [];
                isProcessing = false;
                document.getElementById('game-matches').innerText = matchesFound;

                if (matchesFound === 6) { // 6 pairs
                    document.getElementById('game-end-feedback').innerText = `ğŸ‰ æ­å–œå®Œæˆï¼å…±å˜—è©¦äº† ${attempts} æ¬¡ã€‚`;
                    document.getElementById('game-end-feedback').className = 'feedback-msg correct';
                }

            } else {
                // NO MATCH
                document.getElementById('game-end-feedback').innerText = "âœ— é…å°å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚";
                document.getElementById('game-end-feedback').className = 'feedback-msg wrong';
                
                // Flip back after a delay
                setTimeout(() => {
                    // Find the container elements and remove the flipped class
                    const el1 = document.querySelector(`[data-index="${gameCards.indexOf(card1)}"] .game-card`);
                    const el2 = document.querySelector(`[data-index="${gameCards.indexOf(card2)}"] .game-card`);
                    
                    if (el1) el1.classList.remove('flipped');
                    if (el2) el2.classList.remove('flipped');
                    
                    card1.isFlipped = false;
                    card2.isFlipped = false;
                    
                    cardsFlipped = [];
                    isProcessing = false;
                    document.getElementById('game-end-feedback').innerText = "";
                }, 1200);
            }
        }
    }
</script>

</body>
</html>